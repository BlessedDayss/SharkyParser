name: Sync SonarCloud Issues to GitHub

on:
  workflow_run:
    workflows: ["SonarQube Cloud Analysis"]
    types: [completed]
  workflow_dispatch:

jobs:
  sync-issues:
    name: Create GitHub Issues from SonarCloud
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    permissions:
      issues: write
      contents: read

    steps:
      - name: Wait for SonarCloud processing
        run: sleep 600

      - name: Fetch SonarCloud issues and create GitHub Issues
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_PROJECT: "BlessedDayss_SharkyParserDev"
        run: |
          echo "Fetching issues from SonarCloud..."

          RESPONSE=$(curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=$SONAR_PROJECT&statuses=OPEN,CONFIRMED&ps=100&resolved=false")

          TOTAL=$(echo "$RESPONSE" | jq '.total')
          echo "Found $TOTAL open issues in SonarCloud"

          if [ "$TOTAL" -eq 0 ] || [ "$TOTAL" = "null" ]; then
            echo "No issues found. Exiting."
            exit 0
          fi

          CREATED=0
          SKIPPED=0
          FAILED=0

          echo "$RESPONSE" | jq -c '.issues[]' | while read -r ISSUE; do
            SONAR_KEY=$(echo "$ISSUE" | jq -r '.key')
            MESSAGE=$(echo "$ISSUE" | jq -r '.message')
            SEVERITY=$(echo "$ISSUE" | jq -r '.severity // "MINOR"')
            TYPE=$(echo "$ISSUE" | jq -r '.type // "CODE_SMELL"')
            COMPONENT=$(echo "$ISSUE" | jq -r '.component' | sed "s|${SONAR_PROJECT}:||")
            LINE=$(echo "$ISSUE" | jq -r '.line // "N/A"')
            RULE=$(echo "$ISSUE" | jq -r '.rule')
            EFFORT=$(echo "$ISSUE" | jq -r '.effort // "N/A"')

            case "$TYPE" in
              BUG)            TYPE_LABEL="bug" ;;
              VULNERABILITY)  TYPE_LABEL="security" ;;
              *)              TYPE_LABEL="code-quality" ;;
            esac

            TITLE="[SonarCloud] ${MESSAGE}"

            EXISTING=$(gh issue list --repo "$GITHUB_REPOSITORY" --search "$SONAR_KEY" --state open --json number --jq 'length' 2>/dev/null || echo "0")

            if [ "$EXISTING" -gt 0 ]; then
              echo "⏭ Skip: $MESSAGE"
              SKIPPED=$((SKIPPED + 1))
              continue
            fi

            BODY="## SonarCloud Issue

          **Rule:** \`${RULE}\`
          **Severity:** ${SEVERITY}
          **Type:** ${TYPE}
          **File:** \`${COMPONENT}\`
          **Line:** ${LINE}
          **Effort:** ${EFFORT}

          ### Description
          ${MESSAGE}

          [View in SonarCloud](https://sonarcloud.io/project/issues?id=${SONAR_PROJECT}&open=${SONAR_KEY})

          ---
          *Sonar Key: ${SONAR_KEY}*"

            echo "➕ Creating: $TITLE"
            if gh issue create \
              --repo "$GITHUB_REPOSITORY" \
              --title "$TITLE" \
              --body "$BODY" \
              --label "$TYPE_LABEL" \
              --label "sonarcloud"; then
              CREATED=$((CREATED + 1))
            else
              echo "❌ Failed: $TITLE"
              FAILED=$((FAILED + 1))
            fi

            sleep 1
          done

          echo ""
          echo "=== Summary ==="
          echo "Created: $CREATED"
          echo "Skipped: $SKIPPED"
          echo "Failed:  $FAILED"
