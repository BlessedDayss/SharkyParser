<div class="log-explorer">
  <header class="header-row">
    <div>
      <h2 class="title">Log Explorer</h2>
      <p class="subtitle">Categorize and navigate through thousands of logs</p>
    </div>
    <div class="file-info font-mono">{{ fileName() }}</div>
  </header>

  @if (statistics(); as stats) {
  <div class="stats-grid">
    <button class="stat-card total" [class.active]="levelFilter() === 'ALL'" (click)="setLevelFilter('ALL')">
      <span class="stat-label">Total Entries</span>
      <span class="stat-value">{{ stats.total }}</span>
    </button>
    <button class="stat-card error" [class.active]="levelFilter() === 'ERROR'" (click)="setLevelFilter('ERROR')">
      <span class="stat-label">Errors</span>
      <span class="stat-value">{{ stats.errors }}</span>
    </button>
    <button class="stat-card warning" [class.active]="levelFilter() === 'WARN'" (click)="setLevelFilter('WARN')">
      <span class="stat-label">Warnings</span>
      <span class="stat-value">{{ stats.warnings }}</span>
    </button>
    <button class="stat-card info" [class.active]="levelFilter() === 'INFO'" (click)="setLevelFilter('INFO')">
      <span class="stat-label">Info logs</span>
      <span class="stat-value">{{ stats.info }}</span>
    </button>

    @if (timeFilter()) {
    <div class="stat-card time-filter active" (click)="timeFilter.set(null)" title="Click to clear filter">
      <span class="stat-label">Time Filter Active</span>
      <span class="stat-value">{{ timeFilter() | date:'HH:mm' }} <span class="clear-icon">âœ•</span></span>
    </div>
    }
  </div>
  }

  @if (loading()) {
  <div class="loading">Parsing...</div>
  }

  @if (error()) {
  <div class="error-msg">{{ error() }}</div>
  }

  @if (entries().length > 0) {
  <div class="log-viewer-container">
    <div class="viewer-header">
      <input type="text" class="search-bar" placeholder="Search logs/messages..." [ngModel]="searchTerm()"
        (ngModelChange)="searchTerm.set($event)" />
      <select class="level-select" [ngModel]="levelFilter()" (ngModelChange)="levelFilter.set($event)">
        <option value="ALL">All Levels</option>
        <option value="ERROR">Errors</option>
        <option value="WARN">Warnings</option>
        <option value="INFO">Information</option>
        <option value="DEBUG">Debug</option>
      </select>
    </div>
    <div class="table-wrapper">
      <table class="log-table">
        <thead>
          <tr>
            @for (col of columns(); track col.name) {
            <th [style.width]="col.name === 'Timestamp' ? '180px' : col.name === 'Level' ? '100px' : 'auto'">
              {{ col.header }}
            </th>
            }
          </tr>
        </thead>
        <tbody>
          @for (entry of filteredEntries().slice(0, 10000); track entry.id) {
          <tr class="log-row" (click)="openModal(entry)" (keydown.enter)="openModal(entry)" tabindex="0">
            @for (col of columns(); track col.name) {
            <td>
              @if (col.name === 'Level') {
              <span class="level-tag" [class]="'level-' + entry.level.toLowerCase()">{{ entry.level }}</span>
              } @else if (col.name === 'Timestamp') {
              <span class="timestamp">{{ formatTimestamp(entry.timestamp) }}</span>
              } @else {
              <span [class.message]="col.name === 'Message'">{{ getFieldValue(entry, col.name) }}</span>
              }
            </td>
            }
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
  }

  @if (!loading() && entries().length === 0 && !error()) {
  <div class="empty-state glass-panel glow-border">
    <div class="empty-badge">Parsing at the Speed of Light</div>
    <p>Select a log file to get started</p>
    <p class="hint">Use the "Get Started" button in the sidebar</p>
  </div>
  }
</div>

@if (showAiPrompt()) {
<div class="ai-prompt-card" (click)="$event.stopPropagation()">
  <button class="ai-prompt-close" (click)="dismissAiPrompt()">&times;</button>
  <div class="ai-prompt-icon">
    <span class="material-symbols-outlined">smart_toy</span>
  </div>
  <p class="ai-prompt-title">Want a quick analysis?</p>
  <p class="ai-prompt-desc">Let the AI Agent summarize errors, detect patterns, and explain your logs in seconds.</p>
  <button class="ai-prompt-btn" (click)="goToAiAgent()">
    <span class="material-symbols-outlined">arrow_forward</span>
    Open AI Agent
  </button>
</div>
}

@if (showModal() && selectedEntry(); as entry) {
<div class="modal-overlay" (click)="closeModal()" (keydown.escape)="closeModal()" tabindex="0">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Log Details</h3>
      <button class="close-btn" (click)="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="detail-section">
        <strong>Timestamp:</strong> {{ formatTimestamp(entry.timestamp) }}
      </div>
      <div class="detail-section">
        <strong>Level:</strong>
        <span class="level-tag" [class]="'level-' + entry.level.toLowerCase()">{{ entry.level }}</span>
      </div>
      <div class="detail-section">
        <strong>Message:</strong>
        <pre class="message-pre">{{ entry.message }}</pre>
      </div>

      @for (field of entry.fields | keyvalue; track field.key) {
      <div class="detail-section">
        <strong>{{ field.key }}:</strong> {{ field.value }}
      </div>
      }

      @if (entry.rawData) {
      <div class="detail-section">
        <strong>Raw Data:</strong>
        <pre class="stack-pre">{{ entry.rawData }}</pre>
      </div>
      }
    </div>
  </div>
</div>
}